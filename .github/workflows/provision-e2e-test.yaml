name: provision-e2e-test (reusable)

on:
  workflow_call:
    inputs:
      release:
        required: true
        type: string
    secrets:
      E2E_VM_SSH_PRIV_KEY:
        required: true
      E2E_VM_SSH_PUB_KEY:
        required: true

env:
  DEBIAN_FRONTEND: noninteractive
  VM_NAME_BASE: e2e-runner
  ARTIFACTS_DIR: /tmp/e2e-artifacts
  E2E_TESTS_DIR: e2e-tests

jobs:
  provision-vm:
    name: Provision VM for e2e-tests (${{ inputs.release }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      packages: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Restore cached VM image (if available)
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ inputs.release }}.qcow2
          key: >-
            e2e-runner-vm-${{ inputs.release }}-${{ hashFiles(
              'e2e-tests/vm/**',
              '.github/actions/e2e-tests/set-up-ssh-keys/**',
              '.github/workflows/provision-e2e-test.yaml'
            ) }}
          fail-on-cache-miss: false

      - uses: canonical/desktop-engineering/gh-actions/common/dpkg-install-speedup@main
        if: steps.restore-cache.outputs.cache-hit != 'true'

      - name: Install APT dependencies for VM provisioning
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: ./${{ env.E2E_TESTS_DIR }}/vm/install-provision-deps.sh

      - name: Set up SSH keys for the VM provisioning
        id: set-ssh-keys
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: ./.github/actions/e2e-tests/set-up-ssh-keys
        with:
          E2E_VM_SSH_PRIV_KEY: ${{ secrets.E2E_VM_SSH_PRIV_KEY }}
          E2E_VM_SSH_PUB_KEY: ${{ secrets.E2E_VM_SSH_PUB_KEY }}

      - name: Provision the VM
        id: provision-vm
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: |
          set -eu
          export PATH="$(realpath "${{ env.E2E_TESTS_DIR }}/vm/helpers"):${PATH}"
          mkdir -p ${{ env.ARTIFACTS_DIR }}
          env VM_NAME_BASE="${{ env.VM_NAME_BASE }}" \
            RELEASE="${{ inputs.release }}" \
            ARTIFACTS_DIR="${{ env.ARTIFACTS_DIR }}" \
            SSH_PUBLIC_KEY_FILE="${{ steps.set-ssh-keys.outputs.keys-path }}/id_rsa.pub" \
            ./${{ env.E2E_TESTS_DIR }}/vm/provision-ubuntu.sh

      - name: Clean previous cache
        if: always() && steps.provision-vm.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -eu
          gh cache delete e2e-runner-${{ inputs.release }} || true
          echo "Previous cache (if any) deleted"

      - name: Cache the VM image
        uses: actions/cache/save@v4
        if: always() && steps.provision-vm.outcome == 'success'
        with:
          path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ inputs.release }}.qcow2
          key: >-
            e2e-runner-vm-${{ inputs.release }}-${{ hashFiles(
              'e2e-tests/vm/**',
              '.github/actions/e2e-tests/set-up-ssh-keys/**',
              '.github/workflows/provision-e2e-test.yaml'
            ) }}

      - uses: oras-project/setup-oras@v1
      - name: Upload VM image as OCI artifact
        if: steps.provision-vm.outcome == 'success' || steps.restore-cache.outputs.cache-hit == 'true'
        env:
          IMAGE_PATH: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ inputs.release }}.qcow2
          OCI_REPO: ghcr.io/${{ github.repository }}/e2e-runner
          OCI_TAG: ${{ inputs.release }}
        run: |
          set -euo pipefail
          
          echo "${{ secrets.GITHUB_TOKEN }}" \
            | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

          # Chunk qcow2 into stable fixed-size layers (64 MiB)
          WORKDIR=$(mktemp -d)
          split -b 64M "$IMAGE_PATH" "$WORKDIR/chunk-"

          # Push as a layered OCI artifact (each chunk becomes a layer)
          cd "$WORKDIR"
          oras push "${OCI_REPO}:${OCI_TAG}" chunk-* --artifact-type application/vnd.qemu.qcow2
