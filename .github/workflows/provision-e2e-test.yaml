name: provision-e2e-test (reusable)

on:
  workflow_call:
    inputs:
      release:
        required: true
        type: string
    secrets:
      E2E_VM_SSH_PRIV_KEY:
        required: true
      E2E_VM_SSH_PUB_KEY:
        required: true

env:
  DEBIAN_FRONTEND: noninteractive
  VM_NAME_BASE: e2e-runner
  ARTIFACTS_DIR: /tmp/e2e-artifacts
  E2E_TESTS_DIR: authd-oidc-brokers/e2e-tests

jobs:
  provision-vm:
    name: Provision VM for e2e-tests (${{ inputs.release }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Restore cached VM image (if available)
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ inputs.release }}.qcow2
          key: e2e-runner-${{ inputs.release }}
          fail-on-cache-miss: false

      - name: Checkout repo
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4

      - uses: canonical/desktop-engineering/gh-actions/common/dpkg-install-speedup@main
        if: steps.restore-cache.outputs.cache-hit != 'true'

      - name: Install APT dependencies for VM provisioning
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: ./${{ env.E2E_TESTS_DIR }}/vm/install-provision-deps.sh

      - name: Set up SSH keys for the VM provisioning
        id: set-ssh-keys
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: ./.github/actions/e2e-tests/set-up-ssh-keys
        with:
          E2E_VM_SSH_PRIV_KEY: ${{ secrets.E2E_VM_SSH_PRIV_KEY }}
          E2E_VM_SSH_PUB_KEY: ${{ secrets.E2E_VM_SSH_PUB_KEY }}

      - name: Provision the VM
        id: provision-vm
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: |
          set -eu
          sudo chmod +x "${{ env.E2E_TESTS_DIR }}/vm/helpers/virsh"
          export PATH="$(realpath "${{ env.E2E_TESTS_DIR }}/vm/helpers"):${PATH}"
          mkdir -p ${{ env.ARTIFACTS_DIR }}
          env VM_NAME_BASE="${{ env.VM_NAME_BASE }}" \
            RELEASE="${{ inputs.release }}" \
            ARTIFACTS_DIR="${{ env.ARTIFACTS_DIR }}" \
            SSH_PUBLIC_KEY_FILE="${{ steps.set-ssh-keys.outputs.keys-path }}/id_rsa.pub" \
            ./${{ env.E2E_TESTS_DIR }}/vm/provision-ubuntu.sh

      - name: Clean previous cache
        if: always() && steps.provision-vm.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -eu
          gh cache delete e2e-runner-${{ inputs.release }} || true
          echo "Previous cache (if any) deleted"

      - name: Cache the VM image
        uses: actions/cache/save@v4
        if: always() && steps.provision-vm.outcome == 'success'
        with:
          path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ inputs.release }}.qcow2
          key: e2e-runner-${{ inputs.release }}

      - name: Upload cache as artifact
        if: steps.provision-vm.outcome == 'success' || steps.restore-cache.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: e2e-runner-${{ inputs.release }}
          path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ inputs.release }}.qcow2
